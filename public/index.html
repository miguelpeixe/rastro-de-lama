<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="utf-8" />
    <title>Rastro de Lama</title>
    <link rel="stylesheet" href="/assets/skeleton/css/normalize.css" />
    <link rel="stylesheet" href="/assets/skeleton/css/skeleton.css" />
    <link rel="stylesheet" href="/styles/main.css" />
  </head>
  <body ng-app="rastrodelama" ng-controller="Messages">

    <header id="masthead">
      <div class="container">
        <div class="twelve columns">
          <h1>Rastro de Lama</h1>
        </div>
      </div>
    </header>

    <section id="messages">
      <div class="container">
        <div class="twelve columns">
          <h2>Di√°rio de bordo</h2>
          <message ng-repeat="message in messages | orderBy:'date':true" data="message"></message>
        </div>
      </div>
    </section>

    <script type="text/javascript" src="/assets/firebase/firebase.js"></script>
    <script type="text/javascript" src="/assets/angular/angular.min.js"></script>
    <script type="text/javascript" src="/assets/angularfire/dist/angularfire.min.js"></script>
    <script type="text/javascript">
      angular.module('rastrodelama', [
        'firebase'
      ])
      .controller('Messages', [
        '$scope',
        '$firebaseArray',
        function($scope, $firebaseArray) {
          var ref = new Firebase('https://rastrodelama.firebaseio.com/messages');
          $scope.messages = $firebaseArray(ref);
        }
      ])
      .directive('message', [
        function() {
          return {
            restrict: 'E',
            scope: {
              data: '='
            },
            templateUrl: '/message.html',
            replace: true,
            link: function(scope, element, attrs) {

              scope.getTemplateUrl = function() {
                if(scope.data) {
                  if(scope.data.photo) {
                    scope.data.type = 'image';
                  } else if(scope.data.voice || scope.data.audio) {
                    scope.data.type = 'audio';
                  } else if(scope.data.document) {
                    scope.data.type = 'file';
                  } else if(scope.data.location) {
                    scope.data.type = 'map';
                  } else if(scope.data.video) {
                    scope.data.type = 'video';
                  } else if(scope.data.text) {
                    scope.data.type = 'text';
                  }
                }
                if(scope.data.type) {
                  return '/messages/' + scope.data.type + '.html';
                } else {
                  return null
                }
              }

            }
          }
        }
      ])
      .directive('messageImage', [
        function() {
          return {
            restrict: 'E',
            scope: {
              data: '='
            },
            template: '<img ng-src="{{src}}" />',
            replace: true,
            link: function(scope, element, attrs) {

              scope.$watch('data', function(data) {

                scope.src = '/file/' + data[data.length-1].file_id;

              });

            }
          }
        }
      ])
      .directive('messageAudio', [
        '$sce',
        function($sce) {
          return {
            restrict: 'E',
            scope: {
              data: '='
            },
            template: '<audio controls><source ng-src="{{src}}" /></audio>',
            replace: true,
            link: function(scope, element, attrs) {
              scope.$watch('data', function() {
                var id = '';
                if(scope.data.voice) {
                  id = scope.data.voice.file_id;
                } else if(scope.data.audio) {
                  id = scope.data.audio.file_id;
                }
                if(id)
                  scope.src = $sce.trustAsResourceUrl('/file/' + id);
              });
            }
          }
        }
      ])
      .directive('messageVideo', [
        '$sce',
        function($sce) {
          return {
            restrict: 'E',
            scope: {
              data: '='
            },
            template: '<video controls><source ng-src="{{src}}" /></video>',
            replace: true,
            link: function(scope, element, attrs) {
              scope.$watch('data', function() {
                var id = '';
                if(scope.data.video) {
                  id = scope.data.video.file_id;
                }
                if(id)
                  scope.src = $sce.trustAsResourceUrl('/file/' + id);
              });
            }
          }
        }
      ]);
    </script>
  </body>
</html>
